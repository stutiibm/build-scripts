name: Auto-close stale PRs (debug mode)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"   # Will NOT run in forks, only upstream

permissions:
  pull-requests: write
  issues: write

jobs:
  manage-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR age (debug)
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log("===== PR AUTO-CLOSE DEBUG MODE =====");

            // Repository info
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            console.log(`Repository: ${owner}/${repo}`);

            // Token debug (SAFE – masked)
            const token = process.env.GITHUB_TOKEN;
            if (!token) {
              console.log("❌ GITHUB_TOKEN is NOT available");
            } else {
              console.log("✅ GITHUB_TOKEN is available");
              console.log(`Token length: ${token.length}`);
              console.log(`Token preview (masked): ****${token.slice(-4)}`);
            }

            console.log("Fetching open PRs...");

            const prs = await github.paginate(
              github.rest.pulls.list,
              {
                owner,
                repo,
                state: "open",
                per_page: 100
              }
            );

            console.log(`Total open PRs found: ${prs.length}`);

            if (prs.length === 0) {
              console.log("No open PRs. Exiting.");
              return;
            }

            const now = new Date();
            console.log(`Current time (UTC): ${now.toISOString()}`);

            for (const pr of prs) {
              const createdAt = new Date(pr.created_at);
              const ageDays = Math.floor(
                (now - createdAt) / (1000 * 60 * 60 * 24)
              );

              const author = pr.user?.login || "unknown";
              const assignees =
                pr.assignees.map(a => `@${a.login}`).join(" ") || "none";

              console.log("-----------------------------------");
              console.log(`PR #${pr.number}`);
              console.log(`Title      : ${pr.title}`);
              console.log(`Author     : @${author}`);
              console.log(`Assignees  : ${assignees}`);
              console.log(`Created at : ${createdAt.toISOString()}`);
              console.log(`Age (days) : ${ageDays}`);
              console.log(`Draft PR   : ${pr.draft}`);

              // DEBUG MODE — only printing intended action
              if (ageDays === 3) {
                console.log("→ ACTION: Would send reminder (2 days left)");
              } else if (ageDays === 4) {
                console.log("→ ACTION: Would send reminder (1 day left)");
              } else if (ageDays >= 5) {
                console.log("→ ACTION: Would comment and CLOSE this PR");
              } else {
                console.log("→ ACTION: No action required");
              }
            }

            console.log("===== DEBUG RUN COMPLETE =====");
