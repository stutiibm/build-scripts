name: Auto-close inactive PRs (Fork – Minutes)

on:
  workflow_dispatch:

permissions:
  pull-requests: write
  issues: write

jobs:
  manage-prs:
    runs-on: ubuntu-latest

    steps:
      - name: Auto-close inactive PRs (minutes mode)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log("===== PR INACTIVITY CHECK (MINUTES MODE) START =====");

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const prs = await github.paginate(
              github.rest.pulls.list,
              { owner, repo, state: "open", per_page: 100 }
            );

            console.log(`Total open PRs: ${prs.length}`);

            const now = new Date();

            let reminder3Count = 0;
            let reminder4Count = 0;
            let closedCount = 0;

            for (const pr of prs) {
              if (pr.draft) continue;

              const comments = await github.paginate(
                github.rest.issues.listComments,
                { owner, repo, issue_number: pr.number, per_page: 100 }
              );

              const lastActivityDate =
                comments.length > 0
                  ? new Date(comments[comments.length - 1].created_at)
                  : new Date(pr.created_at);

              const inactivityMinutes = Math.floor(
                (now - lastActivityDate) / (1000 * 60)
              );

              const reminder1Exists = comments.some(c =>
                c.body.includes("**Reminder 1**")
              );
              const reminder2Exists = comments.some(c =>
                c.body.includes("**Reminder 2**")
              );
              const closeExists = comments.some(c =>
                c.body.includes("Closing this PR due to inactivity")
              );

              const mentions = [
                `@${pr.user.login}`,
                ...pr.assignees.map(a => `@${a.login}`)
              ].join(" ");

              // Reminder 1: 3–4 minutes
              if (
                inactivityMinutes >= 3 &&
                inactivityMinutes < 4 &&
                !reminder1Exists
              ) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body: `${mentions}

            ⏰ **Reminder 1**

            This PR has had **no activity for 3 minutes**.
            Please respond to keep it open.`
                });

                reminder3Count++;
                console.log(`Reminder 1 sent to PR #${pr.number}`);
              }

              // Reminder 2: 4–5 minutes
              else if (
                inactivityMinutes >= 4 &&
                inactivityMinutes < 5 &&
                !reminder2Exists
              ) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body: `${mentions}

            ⚠️ **Reminder 2**

            This PR has had **no activity for 4 minutes**.
            It will be closed if inactivity continues.`
                });

                reminder4Count++;
                console.log(`Reminder 2 sent to PR #${pr.number}`);
              }

              // Close: ≥5 minutes
              else if (
                inactivityMinutes >= 5 &&
                !closeExists
              ) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body: `${mentions}

            ❌ **Closing this PR due to inactivity**

            No activity for **5 minutes**.
            Please reopen if you wish to continue.`
                });

                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: pr.number,
                  state: "closed"
                });

                closedCount++;
                console.log(`Closed PR #${pr.number}`);
              }
            }

            console.log("===== SUMMARY =====");
            console.log(`Reminder 1 sent: ${reminder3Count}`);
            console.log(`Reminder 2 sent: ${reminder4Count}`);
            console.log(`PRs closed     : ${closedCount}`);
            console.log("===== PR INACTIVITY CHECK END =====");
